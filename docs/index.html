<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Men's League RSVP • Brookridge Golf Club</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- OPTIONAL: Paste your Adobe Fonts Kit link here -->
  <!-- <link rel="stylesheet" href="https://use.typekit.net/XXXXX.css"> -->

  <style>
    :root{
      --brown: #331804;
      --gold: #D7A941;
      --green: #4F512A; /* Use #4F5120 if that was intentional */
      --copper: #A45B28;
      --white: #ffffff;
      --bg-1: #ffffff;
      --bg-2: #ffffff;
      --border: #e6e3da;
    }

    *{ box-sizing:border-box }

    body{
      margin:0;
      font-family: "Mundial", "Inter", "Segoe UI", Arial, sans-serif;
      background: linear-gradient(180deg,var(--bg-1),var(--bg-2));
      color:var(--brown);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .container{ max-width:920px; margin:40px auto; padding:28px }

    .header_box{ display:flex; flex-direction:column; align-items:flex-start; justify-content:flex-start; gap:16px; margin-bottom:20px; text-align:left }
    header{ display:flex; flex-direction:row; align-items:flex-start; justify-content:flex-start; gap:16px; margin-bottom:20px; text-align:left }
    header .title{ flex:1 }
    h1{
      font-size:1.8rem; margin:0; color:var(--green);
      letter-spacing:0.03em; text-transform:uppercase; font-weight:700;
    }
    .sub{ color:var(--gold); font-weight:600; font-size:0.95rem; }

    .notice{
      padding:12px 14px; border-radius:8px; background:var(--white);
      border-left:4px solid var(--green); box-shadow:0 6px 18px rgba(17,17,17,0.03); margin-bottom:16px
    }
    .notice.ok{ border-left-color:var(--green); background:#eef7ea }
    .notice.err{ border-left-color:var(--copper); background:#fff4ee }

    .actions{ margin:12px 0 }
    .btn{
      display:inline-block; padding:10px 16px; border-radius:8px; text-decoration:none; color:var(--white);
      font-weight:700; letter-spacing:0.03em; text-transform:uppercase;
    }
    .btn.accept{ background:var(--green); margin-right:10px }
    .btn.decline{ background:var(--copper) }
    .btn.accept:hover{ filter:brightness(0.75) }
    .btn.decline:hover{ filter:brightness(0.75) }

    .panel{
      background:var(--white); padding:16px; border-radius:12px; border:1px solid var(--border);
      box-shadow:0 6px 12px rgba(18,18,18,0.03)
    }

    .grid{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-top:12px }

    /* Format panel */
    .format_panel{
      background: var(--white);
      border-left: 6px solid var(--gold);
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(18,18,18,0.04);
      margin: 12px 0 16px 0;
    }
    .format_header{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px }
    .format_header h2{font-size:1.4rem; margin:0; color:var(--green);
      letter-spacing:0.03em; text-transform:uppercase; font-weight:700}
    .status-pill{ padding:6px 10px; border-radius:999px; font-weight:700; font-size:0.75rem; color:var(--white); display:inline-block }
    .status-pill.open{ background:var(--green) }
    .status-pill.closed{ background:var(--copper) }

    .format_meta{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap }
    .badge{ background:#f6f4ef; color:#4b3d2f; padding:6px 10px; border-radius:8px; font-weight:700; font-size:0.85rem; border:1px solid var(--border) }

    .format_desc{ margin:10px 0 0 0; color:#4b3d2f; line-height:1.5; font-size:0.95rem }

    ul{ margin:8px 0; padding-left:18px }

    @media (max-width:700px){
      header{ flex-direction:column; align-items:flex-start }
      .grid{ grid-template-columns:1fr }
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="header_box">
      <div class="brand">
        <!-- If your logo is inside static/assets, change src to "assets/logo_green.png" -->
        <img src="assets/logo_green.png" alt="Brookridge Golf Club logo" style="max-width:50%;height:auto;border-radius:6px">
      </div>
      <div class="title">
        <h1>AM Men’s League</h1>
        <div class="sub">Wednesday • 8:30 AM • 9 Holes</div>
      </div>
    </header>

    <section class="format_panel" aria-labelledby="formatTitleLabel">
      <div class="format_header">
        <h2 id="formatTitleLabel"><span id="formatTitle">Best Ball</span></h2>
        <div id="statusPill" class="status-pill closed" aria-live="polite">Closed</div>
      </div>

      <div id="formatSub" class="format_sub" aria-hidden="false">Format: <strong><span id="formatType">Best Ball</span></strong></div>

      <div class="format_meta" id="formatMeta">
        <span class="badge" id="formatDate">—</span>
      </div>

      <p id="formatDesc" class="format_desc">
        Two-man best ball. Shotgun start at 8:30 AM. Nine holes. Please arrive 15 minutes early for tee assignments and briefings.
      </p>
    </section>

    <div class="actions">
      <h2 style="margin:0 0 8px 0;color:var(--green);font-weight:500;letter-spacing:0.03em;font-size:0.8rem;font-style: italic">Are you playing this week?</h2>
      <a id="acceptBtn" class="btn accept" href="#">Playing</a>
      <a id="declineBtn" class="btn decline" href="#">Not Playing</a>
    </div>

    <section class="grid">
      <div class="panel">
        <h2>Playing</h2>
        <ul id="playingList"><li>Loading…</li></ul>
      </div>
      <div class="panel">
        <h2>Pending</h2>
        <ul id="pendingList"><li>Loading…</li></ul>
      </div>
      <div class="panel">
        <h2>Not Playing</h2>
        <ul id="declinedList"><li>Loading…</li></ul>
      </div>
    </section>
  </div>

<!-- Supabase JS (must be loaded BEFORE your app script) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // =========================================================
  // 1) CONFIG — Project URL + Publishable key
  // =========================================================
  const SUPABASE_URL = "https://qvzjziubhqckrvdmnvxo.supabase.co";
  const SUPABASE_PUBLISHABLE_KEY = "sb_publishable_fpm7E0lxuiMsQf1iOgMb5w_7FW7w1r7";

  // Use `sb` instead of `supabase` to avoid "already declared" collisions
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

  // expose for console testing
  window.sb = sb;
  console.log("Supabase client ready:", window.sb);

  // =========================================================
  // 2) URL PARAMS
  //    Example link:
  //    .../index.html?event=12&player=daniel_sandage
  // =========================================================
  const params = new URLSearchParams(window.location.search);
  const EVENT_ID = params.get("event");     // events.id (int8)
  const PLAYER_ID = params.get("player");   // players.id (text slug)

  // =========================================================
  // 3) DOM HOOKS
  // =========================================================
  const playingEl  = document.getElementById("playingList");
  const pendingEl  = document.getElementById("pendingList");
  const declinedEl = document.getElementById("declinedList");

  const acceptBtn  = document.getElementById("acceptBtn");
  const declineBtn = document.getElementById("declineBtn");

  const formatTitleEl = document.getElementById("formatTitle");
  const formatDescEl  = document.getElementById("formatDesc");
  const formatMetaEl   = document.getElementById("formatMeta");
  const statusPillEl   = document.getElementById("statusPill");
  const formatTypeEl   = document.getElementById("formatType");
  const formatSubEl    = document.getElementById("formatSub");

  // =========================================================
  // 4) HELPERS
  // =========================================================
  function sanitize(str) {
    return String(str ?? "").replace(/[<>]/g, "");
  }

  function renderList(el, list, emptyText) {
    el.innerHTML = list.length
      ? list.map(p => `<li>${sanitize(p.first_name)} ${sanitize(p.last_name)}</li>`).join("")
      : `<li>${emptyText}</li>`;
  }

  function sortByName(list) {
    return list.sort((a, b) => {
      const an = `${a.last_name ?? ""} ${a.first_name ?? ""}`.trim();
      const bn = `${b.last_name ?? ""} ${b.first_name ?? ""}`.trim();
      return an.localeCompare(bn);
    });
  }

  function setActive(status) {
    acceptBtn.classList.remove("active");
    declineBtn.classList.remove("active");
    if (status === "playing") acceptBtn.classList.add("active");
    if (status === "not_playing") declineBtn.classList.add("active");
  }

  function disableButtons(disabled) {
    const opacity = disabled ? 0.5 : 1;
    const pe = disabled ? "none" : "auto";
    acceptBtn.style.opacity = opacity;
    declineBtn.style.opacity = opacity;
    acceptBtn.style.pointerEvents = pe;
    declineBtn.style.pointerEvents = pe;
  }

  // =========================================================
  // 5) LOAD EVENT (events table)
  // =========================================================
  async function loadEvent() {
    if (!EVENT_ID) {
      formatTitleEl.textContent = "Missing event";
      formatDescEl.textContent = "Add ?event=EVENT_ID to the URL.";
      disableButtons(true);
      return false;
    }

    const { data, error } = await sb
      .from("events")
      .select("id, title, format, description, tee_time, event_date, is_open")
      .eq("id", Number(EVENT_ID))
      .single();

    if (error || !data) {
      formatTitleEl.textContent = "Event not found";
      formatDescEl.textContent = sanitize(error?.message || "Unknown error");
      disableButtons(true);
      return false;
    }

    const headline = data.title || "AM Men's League";
    const formatStr = data.format ? data.format : "";
    const dateStr = data.event_date ? (() => {
      try { return new Date(data.event_date).toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' }); }
      catch (e) { return String(data.event_date); }
    })() : "";

    formatTitleEl.textContent = `${headline}`;

    // meta badges (date only)
    if (formatMetaEl) {
      const badges = [];
      if (dateStr) badges.push(`<span class="badge">${sanitize(dateStr)}</span>`);
      formatMetaEl.innerHTML = badges.length ? badges.join(' ') : `<span class="badge">No details</span>`;
    }

    // description text
    formatDescEl.textContent = sanitize(data.description || "");

    // subheading: Format: ...
    if (formatTypeEl && formatSubEl) {
      if (formatStr) {
        formatTypeEl.textContent = sanitize(formatStr);
        formatSubEl.style.display = '';
        formatSubEl.setAttribute('aria-hidden', 'false');
      } else {
        formatTypeEl.textContent = '';
        formatSubEl.style.display = 'none';
        formatSubEl.setAttribute('aria-hidden', 'true');
      }
    }

    // status pill: Open vs Closed
    if (statusPillEl) {
      if (data.is_open === true) {
        statusPillEl.textContent = 'Registration Open';
        statusPillEl.classList.remove('closed');
        statusPillEl.classList.add('open');
      } else {
        statusPillEl.textContent = 'Registration Closed';
        statusPillEl.classList.remove('open');
        statusPillEl.classList.add('closed');
      }
    }

    // is_open default is false in your schema — only enable if true
    disableButtons(data.is_open !== true);

    return true;
  }

  // =========================================================
  // 6) LOAD ROSTER + RSVPS AND RENDER 3 LISTS
  // =========================================================
  async function loadAndRenderRoster() {
    if (!EVENT_ID) return;

    // active players
    const { data: players, error: pErr } = await sb
      .from("players")
      .select("id, first_name, last_name")
      .eq("active", true);

    if (pErr) {
      playingEl.innerHTML = `<li>${sanitize(pErr.message)}</li>`;
      pendingEl.innerHTML = `<li>—</li>`;
      declinedEl.innerHTML = `<li>—</li>`;
      return;
    }

    // RSVPs for this event
    const { data: rsvps, error: rErr } = await sb
      .from("rsvps")
      .select("player_id, status")
      .eq("event_id", Number(EVENT_ID));

    if (rErr) {
      playingEl.innerHTML = `<li>${sanitize(rErr.message)}</li>`;
      pendingEl.innerHTML = `<li>—</li>`;
      declinedEl.innerHTML = `<li>—</li>`;
      return;
    }

    // map player_id -> status
    const statusByPlayer = new Map();
    for (const r of (rsvps || [])) statusByPlayer.set(r.player_id, r.status);

    const playing = [];
    const notPlaying = [];
    const pending = [];

    for (const pl of (players || [])) {
      const status = statusByPlayer.get(pl.id);

      if (status === "playing") playing.push(pl);
      else if (status === "not_playing") notPlaying.push(pl);
      else pending.push(pl); // includes missing row OR status='pending'
    }

    renderList(playingEl,  sortByName(playing),    "None playing yet");
    renderList(pendingEl,  sortByName(pending),    "No one pending");
    renderList(declinedEl, sortByName(notPlaying), "No declines");

    // highlight current player's status (if present)
    if (PLAYER_ID) {
      const myStatus = statusByPlayer.get(PLAYER_ID);
      if (myStatus) setActive(myStatus);
    }
  }

  // =========================================================
  // 7) WRITE RSVP (UPSERT)
  // =========================================================
  async function upsertRsvp(newStatus) {
    if (!EVENT_ID) return alert("Missing ?event=...");
    if (!PLAYER_ID) return alert("Missing ?player=... (send a personalized link or add a dropdown)");

    const payload = {
      event_id: Number(EVENT_ID),
      player_id: PLAYER_ID,
      status: newStatus
    };

    const { error } = await sb
      .from("rsvps")
      .upsert(payload, { onConflict: "event_id,player_id" });

    if (error) {
      alert(error.message);
      return;
    }

    setActive(newStatus);
    await loadAndRenderRoster();
  }

  acceptBtn.addEventListener("click", (e) => {
    e.preventDefault();
    upsertRsvp("playing");
  });

  declineBtn.addEventListener("click", (e) => {
    e.preventDefault();
    upsertRsvp("not_playing");
  });

  // =========================================================
  // 8) INIT + OPTIONAL REALTIME UPDATES
  // =========================================================
  (async function init() {
    const ok = await loadEvent();
    if (!ok) return;

    await loadAndRenderRoster();

    // Optional: realtime refresh for this event’s RSVPs
    sb
      .channel("rsvps-live")
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "rsvps", filter: `event_id=eq.${EVENT_ID}` },
        () => loadAndRenderRoster()
      )
      .subscribe();
  })();
</script>
</body>
</html>